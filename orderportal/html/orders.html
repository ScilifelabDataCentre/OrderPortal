{# List of all orders; for staff. #}

{% extends "base.html" %}

{% block head_title %}Orders{% end %}
{% block body_title %}
{% module Icon('order', title='Orders', label=True) %}
{% end %}

{% block header-css %}
<link rel="stylesheet" type="text/css"
      href="{{ static_url('DataTables-1.10.10/css/dataTables.bootstrap.min.css') }}">
{% end %}

{% block content %}
<form action="{{ reverse_url('orders', **params) }}"
      id="refresh"
      role="form"
      class="form-inline"
      method="GET">
  <div class="row">
    <div class="col-md-7 col-md-offset-3">
      <span class="glyphicon glyphicon-filter"></span>
      <div class="form-group">
	<label for="status">Filter by</label>
	<select name="status" id="status" class="form-control refresh">
	  <option value="">[any status]</option>
	  {% for status in settings['ORDER_STATUSES'] %}
	  {% set sid = status['identifier'] %}
	  {% set sel = sid == params.get('status') and 'selected' or '' %}
	  <option {{ sel }} value="{{ sid }}">{{ sid.capitalize() }}</option>
	  {% end %}
	</select>
      </div>
      <div class="form-group">
	<select name="form" id="form" class="form-control refresh">
	  <option value="">[any form]</option>
	  {% for ftitle, fid in forms %}
	  {% set sel = fid == params.get('form') and 'selected' or '' %}
	  <option {{ sel }} value="{{ fid }}">{{ ftitle }}</option>
	  {% end %}
	</select>
      </div>
    </div>
    <div class="col-md-2">
    </div>
  </div>
</form>

<div class="row">
  <div class="col-md-12">
    <table id="orders"
	   class="table table-striped table-condensed"
	   data-page-length="25">
      <thead>
	<tr>
	  <th>{% module Icon('order', label=True) %}</th>
	  <th width="35%">Title</th>
	  <th>{% module Icon('form', label=True) %}</th>
	  <th>{% module Icon('account', label=True, title='Owner') %}</th>
	  <th>Status</th>
	  {% for st in settings['ORDER_LIST_HISTORY'] %}
	  <th>{% module Icon(st, label=True) %}</th>
	  {% end %}
	  <th>Modified</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
{% end %}{# block content #}

{% block javascript_code %}
{% import json %}
<script type="text/javascript" charset="utf8"
	src="{{ static_url('DataTables-1.10.10/js/jquery.dataTables.min.js') }}">
</script>

<script type="text/javascript" >
$(document).ready(function() {
  $('.refresh').change(function () {
    $('#refresh').submit();
  });
  $('#orders').DataTable( {
    "pagingType": "full_numbers",
    "order": [[{{ 4 + len(settings['ORDER_LIST_HISTORY']) }}, 'desc']],
    ajax: {
      url: '/api/v1/orders',
      dataSrc: 'data',
      data: {% raw json.dumps(params) %}
    },
    columns: [
      {data: 'identifier',
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.href+"'>"+oData.identifier+"</a>");
       }
      },
      {data: 'title'},
      {data: 'form_title',
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.form_href+"'>"+oData.form_title+"</a>");
       }
      },
      {data: 'owner_name',
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.owner_href+"'>"+oData.owner_name+"</a>");
       }
      },
      {data: 'status'},
      {% for st in settings['ORDER_LIST_HISTORY'] %}
      {data: 'history.{{ st }}'},
      {% end %}
      {data: 'modified',
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html($.localtime.toLocalTime(oData.modified));
       }
      }
    ]
  });
});
</script>

<script type="text/javascript" charset="utf8"
	src="{{ static_url('DataTables-1.10.10/js/dataTables.bootstrap.min.js') }}">
</script>
{% end %}
