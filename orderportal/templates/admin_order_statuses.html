{# Admin order statuses page. #}

{% extends "base.html" %}

{% block head_title %}{{ terminology('Order') }} statuses{% end %}

{% block body_title %}{{ terminology('Order') }} statuses{% end %}

{% block content %}
{% if settings.get("ORDER_STATUSES_FILE") or settings.get("ORDER_TRANSITIONS_FILE") %}
<div class="well">
  <strong>NOTE!</strong> The site files named by settings ORDER_STATUSES_FILE and
  ORDER_TRANSITIONS_FILE are no longer used. Remove these settings and files to
  avoid confusion.
</div>
{% end %}

<table class="table">
  <tr>
    <th>Status</th>
    <th>Description</th>
    <th>From</th>
    <th>To</th>
    <th>May edit {{ terminology('order') }}</th>
    <th>May attach to {{ terminology('order') }}</th>
    <th># orders</th>
    <th></th>
  </tr>
  {% for status in parameters['ORDER_STATUSES'] %}
  {% if status.get("enabled") %}
  <tr>
    <th>{% module Icon(status['identifier'], label=True) %}</th>
    <td>
      {{ status['description'] }}
    </td>
    <td>
      {% if status.get('initial') %}
      <i>[initial status]</i><br>
      {% end %}
      {% set none = '[none]' %}
      {% set first = True %}
      {% for trans in parameters['ORDER_TRANSITIONS'] %}
      {% if status['identifier'] in trans['targets'] %}
      {% if first %}
      {% set first = False %}
      {% else %}
      <br>
      {% end %}
      {% set none = '' %}
      <strong>{{ trans['source'] }}</strong>
      ({{', '.join(trans['permission']) }})
      {% end %}
      {% end %}
      {{ none }}
    </td>
    <td>
      {% set none = '[none]' %}
      {% set first = True %}
      {% for trans in parameters['ORDER_TRANSITIONS'] %}
      {% if status['identifier'] == trans['source'] %}
      {% for target in trans['targets'] %}
      {% if first %}
      {% set first = False %}
      {% else %}
      <br>
      {% end %}
      {% set none = '' %}
      <strong>{{ target }}</strong>
      ({{', '.join(trans['permission']) }})
      {% end %}
      {% end %}
      {% end %}
      {{ none }}
    </td>
    <td>
      {{ ', '.join(sorted(set(['admin'] + status.get('edit', [])))) or '-' }}
    </td>
    <td>
      {{ ', '.join(sorted(set(['admin'] + status.get('attach', [])))) or '-' }}
    </td>
    <td>
      <a href="{{ reverse_url('orders', status=status['identifier']) }}" class="badge">
        {{ counts.get(status['identifier'], 0) }}
      </a>
    </td>
    <td>
      <a href="{{ reverse_url('admin_order_status_edit', status['identifier']) }}",
         class="btn btn-sm btn-primary btn-block" role="button">
        <span class="glyphicon glyphicon-edit"></span> Edit status
      </a>
      <a href="{{ reverse_url('admin_order_transitions_edit', status['identifier']) }}",
         class="btn btn-sm btn-primary btn-block" role="button">
        <span class="glyphicon glyphicon-edit"></span> Edit transitions
      </a>
    </td>
  </tr>
  {% end %} {# if status.get("enabled") #}
  {% end %} {# for status in parameters['ORDER_STATUSES'] #}

  {% for status in parameters['ORDER_STATUSES'] %}
  {% if not status.get("enabled") %}
  <tr>
    <th>{% module Icon(status['identifier'], label=True) %}</th>
    <td colspan="6">
      <i>Not enabled</i>
    </td>
    <td>
      <form action="{{ reverse_url('order_status_enable', status['identifier']) }}"
            method="POST" role="form">
        {% module xsrf_form_html() %}
        <button type="submit" class="btn btn-default btn-block"
                onclick="return confirm('Cannot be undone! Really enable?');">
          Set to
          {% module Icon('enabled', label=True) %}
        </button>
      </form>
    </td>
  </tr>
  {% end %} {# if status.get("enabled") #}
  {% end %} {# for status in parameters['ORDER_STATUSES'] #}
</table>
{% end %} {# block content #}
