{# Order fields recursive display. #}

{% for field in fields %}

{# Check if field may not be seen. #}
{% if field['restrict_read'] and not is_staff %}
{% continue %}
{% end %}

{# Is there a visibility condition? If so, check it. #}
{% set fid = field.get('visible_if_field') %}
{% if fid and unicode(order['fields'].get(fid)).lower() not in unicode(field.get('visible_if_value')).lower().split('|') %}
{% continue %}
{% end %}

{% set label = field.get('label') or field['identifier'].capitalize().replace('_', ' ') %}

{% if field['type'] == constants.GROUP %}
<tr>
  <th>
    {% if field['depth'] == 0 %}
    <button data-toggle="collapse" data-target="#{{ field['identifier'] }}"
	    class="btn btn-md">
      <span class="glyphicon glyphicon-triangle-bottom"></span>
      {{ label }}
    </button>
    {% else %}
    <div style="padding-left:{{ 1.5*field['depth'] }}em;">
      {{ label }}
    </div>
    {% end %}
  </th>
  <td></td>
  <td class="small">
    {% module Markdown(field.get('description')) %}
  </td>
  <td>
    {% if field['restrict_read'] %}
    <span class="glyphicon glyphicon-eye-open" title="Readable by staff only.">
    </span>
    {% end %}
    {% if field['restrict_write'] %}
    <span class="glyphicon glyphicon-pencil" title="Writeable by admin only.">
    </span>
    {% end %}
    {% if field['identifier'] in order['invalid'] %}
    <span class="text-danger">
      <span class="glyphicon glyphicon-remove"></span>
      {{ order['invalid'][field['identifier']] }}
    </span>
    {% else %}
    <span class="text-success">
      <span class="glyphicon glyphicon-ok"></span>
    </span>
    {% end %}
  </td>
</tr>

{# Recursion: 'include' cannot be used! #}
{% if field['fields'] %}
{% if field['depth'] == 0 %}
  <tbody id="{{ field['identifier'] }}" class="collapse">
{% end %}
{% module Template('order_fields.html', order=order, fields=field['fields'], is_staff=is_staff) %}
{% if field['depth'] == 0 %}
  </tbody>
{% end %}
{% end %} {# if field['fields'] #}

{% else %}
<tr>
  <th>
    <div style="padding-left:{{ 1.5*field['depth'] }}em;">
      {{ label }}
    </div>
  </th>
  <td>
    {% set value = order['fields'].get(field['identifier']) %}
    {% if field['type'] == constants.TEXT %}
      {% module Markdown(value or '-') %}
    {% else %}
      {% if value is None %}
      -
      {% else %}
      {{ value }}
      {% end %}
    {% end %}
  </td>
  <td class="small">
    {% module Markdown(field.get('description')) %}
  </td>
  <td>
    {% if field['restrict_read'] %}
    <span class="glyphicon glyphicon-eye-open" title="Readable by staff only.">
    </span>
    {% end %}
    {% if field['restrict_write'] %}
    <span class="glyphicon glyphicon-pencil" title="Writeable by admin only.">
    </span>
    {% end %}
    {% if field['identifier'] in order['invalid'] %}
    <span class="text-danger">
      <span data-toggle="tooltip"
	    title="Invalid value; order cannot be submitted."
	    class="glyphicon glyphicon-remove"></span>
      {{ order['invalid'][field['identifier']] }}
    </span>
    {% elif value in (None, '') %}
    <span class="text-danger">
      <span data-toggle="tooltip" title="Field does not require a value."
	    class="glyphicon glyphicon-question-sign"></span>
    </span>
    {% else %}
    <span data-toggle="tooltip" title="Valid value."
	  class="text-success">
      <span class="glyphicon glyphicon-ok"></span>
    </span>
    {% end %}
  </td>
</tr>

{% end %}
{% end %} {# for field in fields #}
